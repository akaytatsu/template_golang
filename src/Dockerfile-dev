FROM golang:1.24-bookworm AS base

ENV GO111MODULE="on"
ENV GOOS="linux"
ENV CGO_ENABLED=1
ENV GOPROXY=https://proxy.golang.org

# System dependencies
RUN apt-get update && apt-get install -y ca-certificates curl bash gcc \
    libc-dev librdkafka-dev

# Usar librdkafka do sistema (glibc) em vez da versão estática musl
ENV CGO_CFLAGS="-O2 -g"
ENV CGO_LDFLAGS="-lresolv"
ENV PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig"

# Instalar todas as ferramentas uma única vez
RUN go install gotest.tools/gotestsum@latest && \
    go install github.com/golang/mock/mockgen@v1.6.0 && \
    go install github.com/smartystreets/goconvey@latest && \
    go install github.com/go-delve/delve/cmd/dlv@latest && \
    go install github.com/air-verse/air@v1.61.1 && \
    go install github.com/swaggo/swag/cmd/swag@latest

FROM base AS dev
WORKDIR /app

# Copiar apenas go.mod e go.sum primeiro para cache de dependências
COPY go.mod go.sum ./
RUN go mod download

# Depois copiar o resto do código
COPY . .

EXPOSE 8080
EXPOSE 2345

ENTRYPOINT ["/go/bin/air"]
